name: AI Security + Architecture Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ai-review-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  ai_review:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.pull_request.draft == false }}

    steps:
      # âœ… Checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # âœ… Fetch PR diff
      - name: Fetch PR diff (bounded)
        env:
          GH_TOKEN: ${{ github.token }}
          PR: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          gh api \
            -H "Accept: application/vnd.github.v3.diff" \
            "/repos/${GITHUB_REPOSITORY}/pulls/${PR}" > pr.diff

          head -c 200000 pr.diff > pr_trimmed.diff

      # âœ… Build AI prompt
      - name: Build AI prompt
        run: |
          cat > prompt.txt << 'EOF'
          You are a senior security and software architecture reviewer.

          Review the following GitHub PR diff and provide:

          ## ğŸ” Security Review
          - vulnerabilities
          - secrets exposure
          - auth problems
          - injection risks

          ## ğŸ—ï¸ Architecture Review
          - design issues
          - maintainability
          - scalability risks

          ## ğŸ’¡ Suggestions
          - concrete improvements

          Be concise but specific.

          --- PR DIFF BELOW ---
          EOF

          cat pr_trimmed.diff >> prompt.txt

      # âœ… Call OpenAIï¼ˆâ† é—œéµä¿®æ­£ç‰ˆï¼‰
      - name: Call OpenAI (Responses API)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail

          python - << 'PY'
          import os, json, urllib.request

          api_key = os.environ.get("OPENAI_API_KEY")
          if not api_key:
              raise SystemExit("âŒ OPENAI_API_KEY missing")

          prompt = open("prompt.txt", "r", encoding="utf-8").read()

          data = {
              "model": "gpt-4.1-mini",
              "input": prompt,
          }

          req = urllib.request.Request(
              "https://api.openai.com/v1/responses",
              data=json.dumps(data).encode(),
              headers={
                  "Authorization": f"Bearer {api_key}",
                  "Content-Type": "application/json",
              },
          )

          with urllib.request.urlopen(req, timeout=120) as resp:
              body = resp.read().decode()

          obj = json.loads(body)

          text = ""
          for item in obj.get("output", []):
              if item.get("type") == "message":
                  for c in item.get("content", []):
                      if c.get("type") == "output_text":
                          text += c.get("text", "")

          if not text.strip():
              text = "AI returned no text output."

          open("review.md", "w", encoding="utf-8").write(text.strip())
          print("âœ… review.md written")
          PY

      # âœ… Post PR comment
      - name: Post PR comment + Review
        env:
          GH_TOKEN: ${{ github.token }}
          PR: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          gh pr comment "$PR" --body-file review.md
          gh pr review "$PR" --comment --body-file review.md
